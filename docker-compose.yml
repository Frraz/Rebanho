# ==============================================================================
# docker-compose.yml — Rebanho (Gestão de Rebanhos)
# Stack: PostgreSQL 16 + Redis 7 + Django/Gunicorn + Celery Worker
# Porta local: 127.0.0.1:8080:8000  (Nginx faz proxy reverso)
#
# Servidor: 2 vCPUs / 7.8GB RAM — dividido entre 4 sistemas Django
# Budget deste sistema: ~0.6 CPU / ~1.0GB RAM total (inclui Celery)
# ==============================================================================

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "5m"
    max-file: "3"

x-restart: &default-restart
  restart: unless-stopped

services:

  # ── PostgreSQL ──────────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    container_name: rebanho_db
    <<: *default-restart
    environment:
      POSTGRES_DB:          ${DB_NAME}
      POSTGRES_USER:        ${DB_USER}
      POSTGRES_PASSWORD:    ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    tmpfs:
      - /tmp:size=64m,mode=1777
    networks:
      - rebanho_net
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    command: >
      postgres
      -c shared_buffers=64MB
      -c work_mem=4MB
      -c maintenance_work_mem=32MB
      -c effective_cache_size=128MB
      -c max_connections=20
      -c random_page_cost=1.1
      -c checkpoint_completion_target=0.9
      -c wal_buffers=8MB
      -c default_statistics_target=100
      -c log_min_duration_statement=1000
      -c log_destination=stderr
    deploy:
      resources:
        limits:
          cpus: "0.4"
          memory: 256M
        reservations:
          cpus: "0.05"
          memory: 128M

  # ── Redis ───────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: rebanho_redis
    <<: *default-restart
    command: >
      redis-server
      --maxmemory 96mb
      --maxmemory-policy allkeys-lru
      --appendonly no
      --save ""
      --loglevel warning
      --tcp-backlog 128
      --timeout 300
      --tcp-keepalive 60
    volumes:
      - redis_data:/data
    tmpfs:
      - /tmp:size=32m,mode=1777
    networks:
      - rebanho_net
    logging: *default-logging
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
        reservations:
          cpus: "0.02"
          memory: 64M

  # ── Web (Django + Gunicorn) ─────────────────────────────────────────────────
  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: rebanho_web:latest
    container_name: rebanho_web
    <<: *default-restart
    env_file: .env
    environment:
      ALLOWED_HOSTS: rebanho.ferzion.com.br,www.rebanho.ferzion.com.br,127.0.0.1,localhost
    volumes:
      - ./staticfiles:/app/staticfiles
      - ./media:/app/media
      - ./logs:/app/logs
    tmpfs:
      - /tmp:size=32m,mode=1777
    ports:
      - "127.0.0.1:8080:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - rebanho_net
    logging: *default-logging
    command:
      - sh
      - -c
      - |
        echo '==> Aguardando DB...' &&
        python manage.py wait_for_db &&
        echo '==> Rodando migrations...' &&
        python manage.py migrate --noinput &&
        echo '==> Seed categorias do sistema...' &&
        python manage.py seed_system_categories &&
        echo '==> Coletando estaticos...' &&
        python manage.py collectstatic --noinput --clear &&
        echo '==> Iniciando Gunicorn...' &&
        exec gunicorn config.wsgi:application --config /app/gunicorn.conf.py
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 384M
        reservations:
          cpus: "0.1"
          memory: 256M

  # ── Celery Worker ───────────────────────────────────────────────────────────
  celery:
    build:
      context: .
      dockerfile: Dockerfile
    image: rebanho_web:latest
    container_name: rebanho_celery
    <<: *default-restart
    env_file: .env
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - rebanho_net
    logging: *default-logging
    command:
      - celery
      - -A
      - config
      - worker
      - --loglevel=warning
      - --concurrency=2
      - --max-tasks-per-child=50
      - --without-gossip
      - --without-mingle
      - --without-heartbeat
    healthcheck:
      test: ["CMD-SHELL", "celery -A config inspect ping -d celery@$$HOSTNAME | grep -q 'pong'"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "0.4"
          memory: 256M
        reservations:
          cpus: "0.05"
          memory: 128M

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  logs_volume:
    driver: local

networks:
  rebanho_net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.driver.mtu: "1450"