name: üöÄ Deploy ‚Äî Gest√£o de Rebanhos

on:
  push:
    branches:
      - main

# Garante que apenas um deploy rode por vez.
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: üöÄ Deploy para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:

      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üìã Informa√ß√µes do deploy
        run: |
          echo "Reposit√≥rio : ${{ github.repository }}"
          echo "Branch      : ${{ github.ref_name }}"
          echo "Commit      : ${{ github.sha }}"
          echo "Autor       : ${{ github.actor }}"
          echo "Mensagem    : ${{ github.event.head_commit.message }}"

      - name: üîÑ Atualizar c√≥digo e rebuild na VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout: 30s
          command_timeout: 12m
          script_stop: true
          script: |
            set -euo pipefail
            PROJECT_DIR="/var/www/docker-instances/Rebanho"
            cd "$PROJECT_DIR"

            echo "[1/5] Atualizando codigo..."
            git fetch origin main
            git reset --hard origin/main
            echo "Commit: $(git log -1 --oneline)"

            echo "[2/5] Rebuild da imagem web..."
            docker compose build web

            echo "[3/5] Aplicando novo container web..."
            docker compose --env-file .env.prod up -d --no-deps web

            echo "[4/5] Reiniciando Celery..."
            docker compose restart celery

            echo "[5/5] Limpando imagens antigas..."
            docker image prune -f

            echo "Deploy concluido: $(git log -1 --oneline)"

      - name: üè• Health check da aplicacao
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout: 30s
          command_timeout: 3m
          script_stop: true
          script: |
            set -euo pipefail
            PROJECT_DIR="/var/www/docker-instances/Rebanho"

            echo "Aguardando 30s..."
            sleep 30

            echo "Status dos containers:"
            docker compose -f "$PROJECT_DIR/docker-compose.yml" ps

            echo "Testando HTTP na porta 8080..."
            RETRIES=5
            COUNT=0
            HTTP_OK=0

            while [ $COUNT -lt $RETRIES ]; do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://127.0.0.1:8080/login/ 2>/dev/null || echo "000")
              echo "  Tentativa $((COUNT+1))/$RETRIES ‚Äî HTTP $CODE"

              if [ "$CODE" = "200" ] || [ "$CODE" = "302" ]; then
                HTTP_OK=1
                break
              fi

              COUNT=$((COUNT + 1))
              sleep 5
            done

            if [ $HTTP_OK -eq 1 ]; then
              echo "OK ‚Äî aplicacao respondendo HTTP $CODE"
            else
              echo "FALHOU ‚Äî aplicacao nao respondeu apos $RETRIES tentativas"
              echo "Ultimos logs:"
              docker compose -f "$PROJECT_DIR/docker-compose.yml" logs --tail=30 web
              exit 1
            fi

      - name: ‚úÖ Sucesso
        if: success()
        run: |
          echo "DEPLOY CONCLUIDO COM SUCESSO"
          echo "Commit : ${{ github.sha }}"
          echo "Autor  : ${{ github.actor }}"
          echo "URL    : https://rebanho.ferzion.com.br"

      - name: ‚ùå Falha
        if: failure()
        run: |
          echo "DEPLOY FALHOU"
          echo "Commit : ${{ github.sha }}"
          echo "Autor  : ${{ github.actor }}"
          exit 1