name: ğŸš€ Deploy â€” GestÃ£o de Rebanhos

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy para VPS
    runs-on: ubuntu-latest

    steps:

      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:        ${{ secrets.VPS_HOST }}
          username:    ${{ secrets.VPS_USER }}
          key:         ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout:     120s
          command_timeout: 15m
          script_stop: true

          script: |
            set -e

            echo "========================================"
            echo "  DEPLOY â€” GestÃ£o de Rebanhos"
            echo "  $(date '+%d/%m/%Y %H:%M:%S')"
            echo "========================================"

            cd /var/www/docker-instances/Rebanho

            # â”€â”€ Atualizar cÃ³digo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ“¦ Atualizando cÃ³digo..."
            git fetch origin main
            git reset --hard origin/main

            # â”€â”€ Garantir gunicorn no requirements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            sed -i 's/^# gunicorn/gunicorn/' requirements.txt

            # â”€â”€ Build da nova imagem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ”¨ Construindo imagem..."
            docker compose build web

            # â”€â”€ Subir container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â™»ï¸  Reiniciando container web..."
            docker compose up -d --no-deps web

            # â”€â”€ Health check com retry (atÃ© 60s) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â³ Aguardando Gunicorn inicializar..."
            TENTATIVAS=0
            MAX=12

            until [ $TENTATIVAS -ge $MAX ]; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 http://127.0.0.1:8080/login/ 2>/dev/null || true)

              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
                echo "âœ… Gunicorn respondendo! (HTTP $HTTP_CODE)"
                break
              fi

              TENTATIVAS=$((TENTATIVAS + 1))
              echo "   Tentativa $TENTATIVAS/$MAX â€” HTTP $HTTP_CODE â€” aguardando 5s..."
              sleep 5
            done

            if [ $TENTATIVAS -ge $MAX ]; then
              echo "âŒ ERRO: Gunicorn nÃ£o respondeu apÃ³s $((MAX * 5))s"
              echo "--- Log do container ---"
              docker compose logs web --tail=40
              exit 1
            fi

            # â”€â”€ Reiniciar Celery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ”„ Reiniciando Celery..."
            docker compose restart celery

            # â”€â”€ Status final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo ""
            echo "ğŸ“Š Status dos containers:"
            docker compose ps

            echo ""
            echo "========================================"
            echo "  âœ… Deploy finalizado com sucesso!"
            echo "  ğŸŒ https://rebanho.ferzion.com.br"
            echo "========================================"