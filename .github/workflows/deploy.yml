name: ğŸš€ Deploy â€” GestÃ£o de Rebanhos

on:
  push:
    branches:
      - main   # Dispara apenas no push para a branch main

jobs:
  deploy:
    name: Deploy para VPS
    runs-on: ubuntu-latest

    steps:

      # â”€â”€ 1. Checkout do cÃ³digo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # â”€â”€ 2. Conectar na VPS e fazer deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:        ${{ secrets.VPS_HOST }}
          username:    ${{ secrets.VPS_USER }}
          key:         ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout:     120s
          script_stop: true   # Para imediatamente se qualquer comando falhar

          script: |
            set -e

            echo "========================================"
            echo "  DEPLOY â€” GestÃ£o de Rebanhos"
            echo "  $(date '+%d/%m/%Y %H:%M:%S')"
            echo "========================================"

            # â”€â”€ Entrar no diretÃ³rio do projeto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cd /var/www/docker-instances/Rebanho

            # â”€â”€ Descartar alteraÃ§Ãµes locais e atualizar â”€â”€â”€â”€â”€
            echo "ğŸ“¦ Atualizando cÃ³digo do repositÃ³rio..."
            git fetch origin main
            git reset --hard origin/main

            # â”€â”€ Garantir que gunicorn estÃ¡ no requirements â”€â”€
            sed -i 's/^# gunicorn/gunicorn/' requirements.txt

            # â”€â”€ Reconstruir imagem com novo cÃ³digo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ”¨ Reconstruindo imagem Docker..."
            docker compose build web

            # â”€â”€ Reiniciar apenas a aplicaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Redis e Celery continuam rodando normalmente
            echo "â™»ï¸  Reiniciando container web..."
            docker compose up -d --no-deps web

            # â”€â”€ Aguardar Gunicorn inicializar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "â³ Aguardando Gunicorn inicializar..."
            sleep 20

            # â”€â”€ Verificar se estÃ¡ respondendo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ğŸ” Verificando saÃºde da aplicaÃ§Ã£o..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8080/login/ || echo "000")

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "âœ… Deploy concluÃ­do com sucesso! (HTTP $HTTP_CODE)"
            else
              echo "âŒ ERRO: Gunicorn retornou HTTP $HTTP_CODE"
              echo "--- Ãšltimas linhas do log ---"
              docker compose logs web --tail=30
              exit 1
            fi

            # â”€â”€ Reiniciar Celery para pegar novo cÃ³digo â”€â”€â”€â”€â”€â”€
            echo "ğŸ”„ Reiniciando Celery..."
            docker compose restart celery

            # â”€â”€ Status final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo ""
            echo "ğŸ“Š Status dos containers:"
            docker compose ps

            echo ""
            echo "========================================"
            echo "  âœ… Deploy finalizado com sucesso!"
            echo "========================================"