name: ðŸš€ Deploy â€” GestÃ£o de Rebanhos

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reason:
        description: "Motivo do deploy manual"
        required: false
        default: "Deploy manual"

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  PROJECT_DIR: /var/www/docker-instances/Rebanho

jobs:
  deploy:
    name: ðŸš€ Deploy para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: production
      url: https://rebanho.ferzion.com.br

    steps:
      - name: ðŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ“‹ InformaÃ§Ãµes do deploy
        run: |
          echo "### ðŸ“‹ InformaÃ§Ãµes do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "| Campo      | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RepositÃ³rio | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch      | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit      | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Autor       | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Mensagem    | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Verificar secrets obrigatÃ³rios
        run: |
          missing=()
          [ -z "${{ secrets.VPS_HOST }}" ]             && missing+=("VPS_HOST")
          [ -z "${{ secrets.VPS_USER }}" ]             && missing+=("VPS_USER")
          [ -z "${{ secrets.VPS_SSH_PRIVATE_KEY }}" ]  && missing+=("VPS_SSH_PRIVATE_KEY")

          if [ ${#missing[@]} -gt 0 ]; then
            echo "âŒ Secrets ausentes: ${missing[*]}"
            exit 1
          fi
          echo "âœ… Todos os secrets estÃ£o configurados."

      - name: ðŸ”„ Atualizar cÃ³digo e rebuild na VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          timeout: 30s
          command_timeout: 12m
          script_stop: true
          script: |
            set -euo pipefail

            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            cd "$PROJECT_DIR"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "[1/5] Atualizando cÃ³digo..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            git fetch origin main
            git reset --hard origin/main
            echo "âœ” Commit: $(git log -1 --oneline)"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "[2/5] Rebuild da imagem web..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker compose build --no-cache web

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "[3/5] Aplicando novo container web..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker compose --env-file .env.prod up -d --no-deps --remove-orphans web

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "[4/5] Reiniciando Celery..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker compose restart celery

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "[5/5] Limpando imagens antigas..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            docker image prune -f

            echo ""
            echo "âœ… Deploy concluÃ­do: $(git log -1 --oneline)"

      - name: ðŸ¥ Health Check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 10m
          script_stop: true
          script: |
            set -euo pipefail

            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            COMPOSE="docker compose -f $PROJECT_DIR/docker-compose.yml"

            echo "ðŸ“¦ Status dos containers:"
            $COMPOSE ps

            echo ""
            echo "â³ Aguardando container 'web' ficar saudÃ¡vel..."

            MAX_WAIT=180
            INTERVAL=5
            ELAPSED=0

            until [ "$ELAPSED" -ge "$MAX_WAIT" ]; do
              STATE=$($COMPOSE ps --format json | jq -r '.[] | select(.Service=="web") | .State // "unknown"')
              echo "   [$ELAPSED/${MAX_WAIT}s] Estado: $STATE"

              if [ "$STATE" = "running" ]; then
                echo "   âœ” Container rodando."
                break
              fi

              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            if [ "$ELAPSED" -ge "$MAX_WAIT" ]; then
              echo "âŒ Timeout aguardando container iniciar."
              $COMPOSE logs --tail=100
              exit 1
            fi

            echo ""
            echo "ðŸŒ Testando endpoint HTTP..."

            RETRIES=12
            SUCCESS=false

            for i in $(seq 1 $RETRIES); do
              CODE=$(curl -sf -o /dev/null -w "%{http_code}" --max-time 10 http://127.0.0.1:8080/login/ || echo "000")
              echo "   Tentativa $i/$RETRIES â€” HTTP $CODE"

              if [[ "$CODE" =~ ^(200|302)$ ]]; then
                SUCCESS=true
                break
              fi

              [ "$i" -lt "$RETRIES" ] && sleep 10
            done

            if [ "$SUCCESS" = false ]; then
              echo ""
              echo "âŒ AplicaÃ§Ã£o nÃ£o respondeu corretamente apÃ³s $RETRIES tentativas."
              echo "ðŸ“‹ Ãšltimos logs:"
              $COMPOSE logs --tail=100
              exit 1
            fi

            echo ""
            echo "âœ… Health check OK â€” AplicaÃ§Ã£o respondendo."

      - name: ðŸ“ Resumo do Deploy
        if: success()
        run: |
          echo "### âœ… Deploy ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** [rebanho.ferzion.com.br](https://rebanho.ferzion.com.br)" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Resumo de Falha
        if: failure()
        run: |
          echo "### âŒ Deploy Falhou" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Autor:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Verifique os logs acima para identificar a causa.**" >> $GITHUB_STEP_SUMMARY
          exit 1