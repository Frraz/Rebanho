name: üöÄ Deploy ‚Äî Gest√£o de Rebanhos

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: üöÄ Deploy para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:

      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üìã Informa√ß√µes do deploy
        run: |
          echo "Reposit√≥rio : ${{ github.repository }}"
          echo "Branch      : ${{ github.ref_name }}"
          echo "Commit      : ${{ github.sha }}"
          echo "Autor       : ${{ github.actor }}"
          echo "Mensagem    : ${{ github.event.head_commit.message }}"

      - name: üîÑ Atualizar c√≥digo e rebuild na VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout: 30s
          command_timeout: 12m
          script_stop: true
          script: |
            set -euo pipefail
            PROJECT_DIR="/var/www/docker-instances/Rebanho"
            cd "$PROJECT_DIR"

            echo "[1/5] Atualizando codigo..."
            git fetch origin main
            git reset --hard origin/main
            echo "Commit: $(git log -1 --oneline)"

            echo "[2/5] Rebuild da imagem web..."
            docker compose build web

            echo "[3/5] Aplicando novo container web..."
            docker compose --env-file .env.prod up -d --no-deps web

            echo "[4/5] Reiniciando Celery..."
            docker compose restart celery

            echo "[5/5] Limpando imagens antigas..."
            docker image prune -f

            echo "Deploy concluido: $(git log -1 --oneline)"

      - name: üè• Health Check Produ√ß√£o
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout: 60s
          command_timeout: 10m
          script_stop: true
          script: |
            set -euo pipefail

            PROJECT_DIR="/var/www/docker-instances/Rebanho"
            COMPOSE="docker compose -f $PROJECT_DIR/docker-compose.yml"

            echo "üì¶ Verificando containers..."
            $COMPOSE ps

            echo ""
            echo "‚è≥ Aguardando container 'web' ficar saud√°vel..."

            MAX_WAIT=180
            INTERVAL=5
            ELAPSED=0

            while true; do
              STATUS=$($COMPOSE ps --format json | jq -r '.[] | select(.Service=="web") | .State')

              echo "   Status atual: $STATUS"

              if [ "$STATUS" = "running" ]; then
                echo "   Container est√° rodando."
                break
              fi

              if [ "$ELAPSED" -ge "$MAX_WAIT" ]; then
                echo "‚ùå Timeout aguardando container iniciar."
                $COMPOSE logs --tail=100
                exit 1
              fi

              sleep $INTERVAL
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            echo ""
            echo "üåê Testando HTTP..."

            RETRIES=12
            for i in $(seq 1 $RETRIES); do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://127.0.0.1:8080/login/ || echo "000")
              echo "   Tentativa $i/$RETRIES ‚Äî HTTP $CODE"

              if [ "$CODE" = "200" ] || [ "$CODE" = "302" ]; then
                echo "‚úÖ Aplica√ß√£o respondendo corretamente."
                exit 0
              fi

              sleep 10
            done

            echo ""
            echo "‚ùå Aplica√ß√£o n√£o respondeu corretamente."
            echo "üìã √öltimos logs:"
            $COMPOSE logs --tail=100

            exit 1

      - name: ‚úÖ Sucesso
        if: success()
        run: |
          echo "DEPLOY CONCLUIDO COM SUCESSO"
          echo "Commit : ${{ github.sha }}"
          echo "Autor  : ${{ github.actor }}"
          echo "URL    : https://rebanho.ferzion.com.br"

      - name: ‚ùå Falha
        if: failure()
        run: |
          echo "DEPLOY FALHOU"
          echo "Commit : ${{ github.sha }}"
          echo "Autor  : ${{ github.actor }}"
          exit 1