name: ðŸš€ Deploy â€” GestÃ£o de Rebanhos

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reason:
        description: "Motivo do deploy manual"
        required: false
        default: "Deploy manual"
      no_cache:
        description: "ForÃ§ar rebuild sem cache?"
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: true

env:
  PROJECT_DIR: /var/www/docker-instances/Rebanho
  APP_URL: https://rebanho.ferzion.com.br
  CONTAINER_NAME: rebanho_web
  APP_PORT: "8080"

jobs:
  deploy:
    name: ðŸš€ Deploy para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 25
    environment:
      name: production
      url: https://rebanho.ferzion.com.br

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # PREPARAÃ‡ÃƒO
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ“‹ InformaÃ§Ãµes do deploy
        run: |
          echo "### ðŸ“‹ Deploy iniciado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo        | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| RepositÃ³rio  | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch       | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit       | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Autor        | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger      | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Mensagem     | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "| Motivo       | ${{ github.event.inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Sem cache    | \`${{ github.event.inputs.no_cache }}\` |" >> $GITHUB_STEP_SUMMARY
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # DEPLOY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ”„ Atualizar cÃ³digo e rebuild na VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 15m
          script_stop: true
          script: |
            set -euo pipefail

            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            NO_CACHE="${{ github.event.inputs.no_cache || 'false' }}"

            sep() { echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"; }

            cd "$PROJECT_DIR"

            sep
            echo "  [1/5] Atualizando cÃ³digo..."
            sep
            git fetch origin main
            git reset --hard origin/main
            echo "  âœ” Commit: $(git log -1 --oneline)"

            sep
            echo "  [2/5] Build da imagem web..."
            sep
            BUILD_FLAGS=""
            if [ "$NO_CACHE" = "true" ]; then
              echo "  âš  Modo sem cache ativado."
              BUILD_FLAGS="--no-cache"
            fi

            # progress=plain exibe cada camada do build para facilitar diagnÃ³stico de erros
            if ! docker compose build --progress=plain $BUILD_FLAGS web 2>&1; then
              echo ""
              echo "âŒ Build falhou. Ãšltimas linhas do log de compose:"
              docker compose logs --tail=50 web 2>&1 || true
              exit 1
            fi

            sep
            echo "  [3/5] Subindo novo container web..."
            sep
            docker compose --env-file .env.prod up -d \
              --no-deps \
              --remove-orphans \
              web

            sep
            echo "  [4/5] Reiniciando Celery..."
            sep
            docker compose restart celery

            sep
            echo "  [5/5] Limpando imagens obsoletas..."
            sep
            docker image prune -f

            echo ""
            echo "âœ… Deploy aplicado: $(git log -1 --oneline)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # HEALTH CHECK
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ðŸ¥ Health Check
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          script_stop: true
          script: |
            set -euo pipefail

            PROJECT_DIR="${{ env.PROJECT_DIR }}"
            CONTAINER="${{ env.CONTAINER_NAME }}"
            APP_PORT="${{ env.APP_PORT }}"
            COMPOSE="docker compose -f $PROJECT_DIR/docker-compose.yml"

            # â”€â”€ 1. Status geral â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "ðŸ“¦ Status dos containers:"
            $COMPOSE ps
            echo ""

            # â”€â”€ 2. Aguardar container ficar pronto â”€â”€â”€â”€â”€
            echo "â³ Aguardando '$CONTAINER' ficar pronto..."

            MAX_WAIT=180
            INTERVAL=5
            ELAPSED=0

            while [ "$ELAPSED" -lt "$MAX_WAIT" ]; do
              HEALTH=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}none{{end}}' "$CONTAINER" 2>/dev/null || echo "not_found")
              STATE=$(docker inspect --format='{{.State.Status}}' "$CONTAINER" 2>/dev/null || echo "not_found")

              echo "   [$ELAPSED/${MAX_WAIT}s] state=$STATE health=$HEALTH"

              case "$STATE" in
                exited|dead)
                  echo "âŒ Container encerrou inesperadamente (state=$STATE)."
                  $COMPOSE logs --tail=150 web
                  exit 1
                  ;;
              esac

              # Pronto quando: healthy, ou running sem healthcheck configurado
              if [ "$HEALTH" = "healthy" ] || { [ "$STATE" = "running" ] && [ "$HEALTH" = "none" ]; }; then
                echo "   âœ” Container pronto."
                break
              fi

              sleep "$INTERVAL"
              ELAPSED=$((ELAPSED + INTERVAL))
            done

            if [ "$ELAPSED" -ge "$MAX_WAIT" ]; then
              echo "âŒ Timeout: container nÃ£o ficou pronto em ${MAX_WAIT}s."
              $COMPOSE logs --tail=150 web
              exit 1
            fi

            # â”€â”€ 3. Teste HTTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo ""
            echo "ðŸŒ Testando endpoint HTTP (porta $APP_PORT)..."

            RETRIES=12
            DELAY=10
            SUCCESS=false

            for i in $(seq 1 "$RETRIES"); do
              CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 \
                    "http://127.0.0.1:${APP_PORT}/login/" || echo "000")
              echo "   Tentativa $i/$RETRIES â€” HTTP $CODE"

              case "$CODE" in
                200|301|302)
                  SUCCESS=true
                  break
                  ;;
                000)
                  echo "   âš  Sem resposta (timeout ou conexÃ£o recusada)."
                  ;;
              esac

              [ "$i" -lt "$RETRIES" ] && sleep "$DELAY"
            done

            if [ "$SUCCESS" = "false" ]; then
              echo ""
              echo "âŒ AplicaÃ§Ã£o nÃ£o respondeu apÃ³s $RETRIES tentativas."
              echo "ðŸ“‹ Logs do container:"
              $COMPOSE logs --tail=150 web
              exit 1
            fi

            echo ""
            echo "âœ… Health check OK â€” AplicaÃ§Ã£o respondendo corretamente."

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # RESULTADO
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: âœ… Resumo de Sucesso
        if: success()
        run: |
          echo "### âœ… Deploy concluÃ­do com sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo   | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit  | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Autor   | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL     | [${{ env.APP_URL }}](${{ env.APP_URL }}) |" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Resumo de Falha
        if: failure()
        run: |
          echo "### âŒ Deploy falhou" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo   | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit  | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Autor   | \`${{ github.actor }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Logs    | Verifique os steps acima para identificar a causa. |" >> $GITHUB_STEP_SUMMARY