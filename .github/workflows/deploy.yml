name: ğŸš€ Deploy â€” GestÃ£o de Rebanhos

on:
  push:
    branches:
      - main

# Garante que apenas um deploy rode por vez.
# Se um novo push chegar enquanto o deploy anterior ainda roda,
# o anterior Ã© cancelado e o novo comeÃ§a.
concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  deploy:
    name: ğŸš€ Deploy para VPS
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:

      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout do repositÃ³rio
        uses: actions/checkout@v4

      # â”€â”€ 2. InformaÃ§Ãµes do deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“‹ InformaÃ§Ãµes do deploy
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  RepositÃ³rio : ${{ github.repository }}"
          echo "  Branch      : ${{ github.ref_name }}"
          echo "  Commit      : ${{ github.sha }}"
          echo "  Autor       : ${{ github.actor }}"
          echo "  Mensagem    : ${{ github.event.head_commit.message }}"
          echo "  Data/Hora   : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”€â”€ 3. Deploy via SSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”„ Atualizar cÃ³digo e rebuild na VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:            ${{ secrets.VPS_HOST }}
          username:        ${{ secrets.VPS_USER }}
          key:             ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout:         30s
          command_timeout: 12m
          script_stop:     true   # aborta ao primeiro erro â€” nÃ£o continua deploy quebrado

          script: |
            set -euo pipefail

            PROJECT_DIR="/var/www/docker-instances/Rebanho"
            cd "$PROJECT_DIR"

            echo "â”â”â” [1/5] Atualizando cÃ³digo â”â”â”"
            git fetch origin main
            git reset --hard origin/main
            echo "  Commit atual: $(git log -1 --oneline)"

            echo "â”â”â” [2/5] Rebuild da imagem web â”â”â”"
            docker compose build web

            echo "â”â”â” [3/5] Aplicando novo container web (zero-downtime) â”â”â”"
            docker compose --env-file .env.prod up -d --no-deps web

            echo "â”â”â” [4/5] Reiniciando Celery â”â”â”"
            docker compose restart celery

            echo "â”â”â” [5/5] Limpando imagens antigas â”â”â”"
            docker image prune -f

            echo ""
            echo "âœ… Deploy concluÃ­do: $(git log -1 --oneline)"

      # â”€â”€ 4. Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ¥ Health check da aplicaÃ§Ã£o
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:            ${{ secrets.VPS_HOST }}
          username:        ${{ secrets.VPS_USER }}
          key:             ${{ secrets.VPS_SSH_PRIVATE_KEY }}
          timeout:         30s
          command_timeout: 3m
          script_stop:     true

          script: |
            set -euo pipefail

            echo "Aguardando aplicaÃ§Ã£o inicializar (30s)..."
            sleep 30

            echo "Verificando HTTP..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 15 \
              --retry 3 \
              --retry-delay 5 \
              http://localhost:8080/login/)

            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "âœ… AplicaÃ§Ã£o respondendo â€” HTTP $HTTP_CODE"
            else
              echo "âŒ Health check falhou â€” HTTP $HTTP_CODE"
              echo "Ãšltimos logs do container web:"
              docker compose -f /var/www/docker-instances/Rebanho/docker-compose.yml \
                logs --tail=30 web
              exit 1
            fi

            echo "Verificando containers..."
            docker compose -f /var/www/docker-instances/Rebanho/docker-compose.yml ps

      # â”€â”€ 5. NotificaÃ§Ã£o de sucesso â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœ… Deploy concluÃ­do com sucesso
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âœ… DEPLOY CONCLUÃDO COM SUCESSO"
          echo ""
          echo "  Commit  : ${{ github.sha }}"
          echo "  Autor   : ${{ github.actor }}"
          echo "  URL     : https://rebanho.ferzion.com.br"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      # â”€â”€ 6. NotificaÃ§Ã£o de falha â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âŒ Falha no deploy
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  âŒ DEPLOY FALHOU"
          echo ""
          echo "  Commit  : ${{ github.sha }}"
          echo "  Autor   : ${{ github.actor }}"
          echo "  Veja os logs acima para identificar o erro."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1